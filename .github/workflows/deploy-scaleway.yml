# CI workflow to build and deploy the static site to Scaleway Object Storage (S3-compatible)
# Triggers on pushes to the main branch and manual dispatches.

name: Deploy to Scaleway Object Storage

on:
  push:
    branches:
      - master
  # Allow manual runs from the GitHub Actions tab
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Common environment variables for this job
    env:
      # Local directory that contains the production build output
      BUILD_DIR: dist

    steps:
      # 1) Check out the repository contents so we can build the project
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Install Node.js (version 20 LTS) and enable npm dependency caching
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 3) Install project dependencies (from package.json / package-lock.json)
      - name: Install dependencies
        run: npm install

      # 4) Run the production build (this will generate the dist/ directory)
      - name: Build application
        run: npm run build

      # 5) Sync the built files in dist/ to Scaleway Object Storage
      #    This uses the jakejarvis/s3-sync-action, which wraps the AWS CLI
      #    and supports custom S3-compatible endpoints (like Scaleway).
      - name: Upload dist/ to Scaleway Object Storage
        uses: jakejarvis/s3-sync-action@v0.5.1
        with:
          # Recommended defaults for static website hosting:
          # --acl public-read      -> make objects publicly readable (bucket must allow it)
          # --follow-symlinks      -> handle any symlinks safely
          # --delete               -> remove remote files that no longer exist in dist/
          args: --acl public-read --follow-symlinks --delete
        env:
          # Name of your Scaleway Object Storage bucket
          AWS_S3_BUCKET: ${{ secrets.SCALEWAY_S3_BUCKET }}

          # Scaleway access key pair with permissions to write to the bucket
          AWS_ACCESS_KEY_ID: ${{ secrets.SCALEWAY_S3_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SCALEWAY_S3_SECRET_ACCESS_KEY }}

          # Scaleway region of the bucket, e.g. "fr-par" or "nl-ams"
          AWS_REGION: ${{ secrets.SCALEWAY_S3_REGION }}

          # Scaleway S3-compatible endpoint, e.g. "https://s3.fr-par.scw.cloud"
          AWS_S3_ENDPOINT: ${{ secrets.SCALEWAY_S3_ENDPOINT }}

          # Local directory to upload (the Vite build output)
          SOURCE_DIR: ${{ env.BUILD_DIR }}

